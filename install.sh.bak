#!/bin/bash
# install.sh - The Master Setup Script for Fedora Minimal (Asahi)

# We use set -e to stop on errors, but we will handle specific errors manually
set -e 

echo "==========================================="
echo "   Kushagra's Fedora Master Setup Script   "
echo "==========================================="

# 0. Safety Check: Ensure we are in the right directory
if [ ! -f "install.sh" ]; then
    echo "‚ùå Error: You are not in the dotfiles directory."
    echo "   Please run: cd ~/dotfiles && ./install.sh"
    exit 1
fi

# 1. Update System
echo "üîÑ Updating system repositories..."
sudo dnf update -y

# 2. Install Essentials
echo "üì¶ Installing Git, Stow, Curl, and Compilers..."
sudo dnf install -y git stow unzip curl fontconfig pkgconf-pkg-config make automake gcc gcc-c++
# sudo dnf install -y "@Development Tools" 

# 3. Install Packages from List
if [ -f "pkglist.txt" ]; then
    echo "üì¶ Installing packages from pkglist.txt..."
    # Filter out comments (#) and empty lines to prevent errors
    PACKAGES=$(grep -vE "^\s*#|^\s*$" pkglist.txt | tr '\n' ' ')
    if [ -n "$PACKAGES" ]; then
        sudo dnf install -y $PACKAGES --skip-unavailable $PACKAGES
    else
        echo "   -> pkglist.txt is empty. Skipping."
    fi
else
    echo "‚ö†Ô∏è  WARNING: pkglist.txt not found! Skipping package installation."
fi

# ---------------------------------------------------------
# 4. MANUAL BUILDS & FONTS
# ---------------------------------------------------------

echo "üõ†Ô∏è  Starting Manual Builds..."

# Create a temp directory for building
BUILD_DIR=$(mktemp -d)
cd "$BUILD_DIR"

# --- A. Build nchat ---
if ! command -v nchat &> /dev/null; then
    echo "   -> Building nchat..."
    set +e # Allow fail
    sudo dnf install -y ncurses-devel sqlite-devel libcurl-devel file-devel openssl-devel
    git clone https://github.com/d99kris/nchat.git
    cd nchat
    ./make.sh && sudo make install
    BUILD_STATUS=$?
    cd ..
    set -e # Safety on
    
    if [ $BUILD_STATUS -ne 0 ]; then
        echo "‚ö†Ô∏è  WARNING: nchat build failed. Skipping."
    fi
else
    echo "   -> nchat is already installed."
fi

# --- B. Build kew ---
if ! command -v kew &> /dev/null; then
    echo "   -> Building kew..."
    set +e
    sudo dnf install -y fftw-devel opusfile-devel chafa-devel taglib-devel libcurl-devel
    git clone https://github.com/ravachol/kew.git
    cd kew
    make && sudo make install
    BUILD_STATUS=$?
    cd ..
    set -e
    
    if [ $BUILD_STATUS -ne 0 ]; then
        echo "‚ö†Ô∏è  WARNING: kew build failed. Skipping."
    fi
else
    echo "   -> kew is already installed."
fi

# --- C. Install Meslo Nerd Font ---
FONT_DIR="$HOME/.local/share/fonts"
if [ ! -d "$FONT_DIR" ]; then
    echo "üî§ Installing Meslo Nerd Font..."
    mkdir -p "$FONT_DIR"
    cd "$FONT_DIR"
    curl -fLo "Meslo.zip" https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Meslo.zip
    unzip -o Meslo.zip
    rm Meslo.zip
    fc-cache -fv
else
    echo "   -> Fonts directory exists. Skipping."
fi

rm -rf "$BUILD_DIR"
echo "‚úÖ Manual builds complete."

# ---------------------------------------------------------
# 5. DOTFILES & SECRETS
# ---------------------------------------------------------

cd ~/dotfiles

# --- PREVENT STOW POLLUTION ---
echo "install.sh" > .stow-local-ignore
echo "pkglist.txt" >> .stow-local-ignore
echo ".git" >> .stow-local-ignore
echo ".gitignore" >> .stow-local-ignore
echo "README.md" >> .stow-local-ignore

# --- CLEAN DEFAULT CONFIGS ---
echo "üßπ Cleaning up default config files to prevent conflicts..."
rm -f ~/.zshrc ~/.bashrc ~/.bash_profile ~/.gitconfig

echo "üîó Stowing Public Dotfiles..."
stow . 

# Setup Private Secrets
echo "==========================================="
echo "üîê SECRETS SETUP"
echo "Enter GitHub Username and PAT when prompted."
echo "==========================================="

if [ ! -d "$HOME/secure_keys" ]; then
    git clone https://github.com/Kushagra1203/secure_keys.git ~/secure_keys
    echo "üîó Stowing Secrets..."
    cd ~/secure_keys
    stow .
else
    echo "‚úÖ secure_keys folder exists. Restowing..."
    cd ~/secure_keys
    stow -R .
fi

# ---------------------------------------------------------
# 6. SHELL & FINISH
# ---------------------------------------------------------

CURRENT_SHELL=$(basename "$SHELL")
if [ "$CURRENT_SHELL" != "zsh" ]; then
    echo "üêö Changing default shell to Zsh..."
    # 'usermod' is the standard way to change shells on Fedora
    sudo usermod --shell $(which zsh) $USER
fi

echo "==========================================="
echo "‚úÖ SETUP COMPLETE! REBOOT YOUR COMPUTER."
echo "==========================================="
